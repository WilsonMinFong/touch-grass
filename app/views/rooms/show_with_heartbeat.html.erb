<div class="max-w-4xl mx-auto">
  <div class="mb-8">
    <%= link_to "â† Back to Rooms", rooms_path, class: "btn btn-ghost" %>
  </div>

  <div class="card bg-base-100 shadow-lg">
    <div class="card-body">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h1 class="card-title text-3xl"><%= @room.name %></h1>
          <div class="text-lg text-gray-600 mt-2">
            Room Code: <span class="badge badge-primary badge-lg"><%= @room.code %></span>
            <% if @is_owner %>
              <span class="badge badge-success ml-2">Owner</span>
            <% end %>
          </div>
        </div>
      </div>
      
      <div class="stats shadow mb-6">
        <div class="stat">
          <div class="stat-title">Active Participants</div>
          <div class="stat-value text-2xl" id="participants-count"><%= @room.active_participants_count %></div>
          <div class="stat-desc">Currently viewing</div>
        </div>
        
        <div class="stat">
          <div class="stat-title">Room Code</div>
          <div class="stat-value text-xl"><%= @room.code %></div>
          <div class="stat-desc">Share this code to join</div>
        </div>
        
        <div class="stat">
          <div class="stat-title">Created</div>
          <div class="stat-value text-lg"><%= @room.created_at.strftime("%b %d") %></div>
          <div class="stat-desc">at <%= @room.created_at.strftime("%I:%M %p") %></div>
        </div>
      </div>

      <!-- Main room content area -->
      <div class="bg-base-200 rounded-lg p-8 text-center mb-6">
        <h2 class="text-xl font-semibold mb-4">Welcome to <%= @room.name %>!</h2>
        <p class="text-gray-600">You are now connected to this room. Other participants will see you as active.</p>
      </div>

      <div class="card-actions justify-between">
        <div>
          <%= link_to "Leave Room", leave_room_path(@room), method: :delete, 
                      class: "btn btn-outline", 
                      data: { confirm: "Are you sure you want to leave this room?" } %>
        </div>
        
        <% if @is_owner %>
          <div class="flex gap-2">
            <button class="btn btn-outline">Edit Room</button>
            <button class="btn btn-error">Delete Room</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  // Heartbeat to maintain presence
  let heartbeatInterval;
  
  function startHeartbeat() {
    heartbeatInterval = setInterval(function() {
      fetch('<%= heartbeat_room_path(@room) %>', {
        method: 'PATCH',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('participants-count').textContent = data.participants_count;
      })
      .catch(error => console.log('Heartbeat error:', error));
    }, 15000); // Every 15 seconds
  }
  
  function stopHeartbeat() {
    if (heartbeatInterval) {
      clearInterval(heartbeatInterval);
    }
  }
  
  // Start heartbeat when page loads
  document.addEventListener('DOMContentLoaded', startHeartbeat);
  
  // Stop heartbeat when page unloads
  window.addEventListener('beforeunload', function() {
    stopHeartbeat();
    // Send leave request
    navigator.sendBeacon('<%= leave_room_path(@room) %>', new FormData());
  });
  
  // Handle visibility change (when user switches tabs)
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      stopHeartbeat();
    } else {
      startHeartbeat();
    }
  });
</script>